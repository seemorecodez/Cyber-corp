name: License Scanning

on:
  pull_request:
    branches: [ main, master, develop ]
    paths:
      - 'frontend/package.json'
      - 'frontend/package-lock.json'
      - 'backend/requirements.txt'
      - '.github/workflows/license-scan.yml'
  push:
    branches: [ main, master, develop ]
    paths:
      - 'frontend/package.json'
      - 'frontend/package-lock.json'
      - 'backend/requirements.txt'
  workflow_dispatch:

jobs:
  license-scan-frontend:
    name: Scan Frontend Licenses
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        working-directory: ./frontend
        run: npm ci

      - name: Install license-checker
        run: npm install -g license-checker

      - name: Check licenses
        working-directory: ./frontend
        run: |
          echo "Checking licenses for frontend dependencies..."
          license-checker --summary
          echo ""
          echo "Detailed license report:"
          license-checker --out licenses-frontend.json --json
          
          # Check for GPL, AGPL, or other restricted licenses
          echo ""
          echo "Checking for restricted licenses..."
          if license-checker --onlyAllow "MIT;Apache-2.0;BSD-2-Clause;BSD-3-Clause;ISC;CC0-1.0;Unlicense;Python-2.0;CC-BY-3.0;CC-BY-4.0" --production 2>&1 | grep -i "license issues"; then
            echo "⚠️  Warning: Some dependencies may have restrictive licenses"
            echo "Please review the licenses manually"
          else
            echo "✓ All production dependencies use permissive licenses"
          fi

      - name: Upload license report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: frontend-license-report
          path: frontend/licenses-frontend.json
          retention-days: 30

  license-scan-backend:
    name: Scan Backend Licenses
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'

      - name: Install pip-licenses
        run: pip install pip-licenses

      - name: Install backend dependencies
        working-directory: ./backend
        run: |
          # Install dependencies excluding the custom one that might not be available
          grep -v "emergentintegrations" requirements.txt > requirements_temp.txt || true
          pip install -r requirements_temp.txt || echo "Some dependencies may not install, continuing..."

      - name: Check licenses
        working-directory: ./backend
        run: |
          echo "Checking licenses for backend dependencies..."
          pip-licenses --summary
          echo ""
          echo "Detailed license report:"
          pip-licenses --format=json --output-file=licenses-backend.json
          pip-licenses --format=markdown --output-file=licenses-backend.md
          
          echo ""
          echo "Checking for GPL/AGPL licenses..."
          if pip-licenses | grep -E "(GPL|AGPL)" | grep -v "LGPL"; then
            echo "⚠️  Warning: Found GPL/AGPL licensed dependencies"
            echo "Please review these licenses carefully"
          else
            echo "✓ No GPL/AGPL licenses detected"
          fi

      - name: Upload license reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: backend-license-report
          path: |
            backend/licenses-backend.json
            backend/licenses-backend.md
          retention-days: 30

  license-report-summary:
    name: License Summary
    runs-on: ubuntu-latest
    needs: [license-scan-frontend, license-scan-backend]
    if: always()
    
    steps:
      - name: Download all license reports
        uses: actions/download-artifact@v4

      - name: Display summary
        run: |
          echo "==================================="
          echo "License Scanning Complete"
          echo "==================================="
          echo ""
          echo "License reports have been generated and uploaded as artifacts."
          echo "Please review the artifacts to ensure compliance with your organization's policies."
          echo ""
          if [ -f frontend-license-report/licenses-frontend.json ]; then
            echo "Frontend license report: ✓ Generated"
          fi
          if [ -f backend-license-report/licenses-backend.json ]; then
            echo "Backend license report: ✓ Generated"
          fi
